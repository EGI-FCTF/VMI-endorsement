---
- name: install epel 
  yum:
    name: epel-release
    state: latest 

- name: install cloud-init and extra packages 
  yum:
    name: [cloud-init, cloud-utils-growpart]
    state: latest 

- name: extra packages for centos 6
  yum:
    name: [dracut-modules-growroot, patch, parted]
    state: latest 
  when: ansible_distribution_major_version == "6"

# Is including the patch here a bit ugly? 
- name: patch cloud-init
  shell: |
    pushd /usr/lib/python2.6/site-packages/cloudinit/sources
    cat > /tmp/cloud-init.patch << EOF
    --- DataSourceOpenNebula.py     2014-10-31 11:57:41.000000000 +0000
    +++ DataSourceOpenNebula.py.orig        2015-06-17 11:02:47.134757659 +0000
    @@ -288,7 +288,7 @@
     
     
     def switch_user_cmd(user):
    -    return ['runuser', '-u', user, '--']
    +    return ['sudo', '-u', user]

     def parse_shell_config(content, keylist=None, bash=None, asuser=None,
                            switch_user_cb=None):
    EOF
    patch < /root/cloud-init.patch
    rm /root/cloud-init.patch
    popd
    python -c "import cloudinit.sources.DataSourceOpenNebula"
  when: ansible_distribution_major_version == "6"


- name: Create fedcloud config
  copy:
    content: |
      # EGI FedCloud configuration
      
      # Make sure to disable ssh password authentication
      ssh_pwauth: 0
      # Regenerate keys
      ssh_deletekeys: True
      ssh_genkeytypes: ['rsa', 'dsa']

      # In OpenNebula, use network based datasource,
      # so that it can successfully resolve IPv4 based hostname
      datasource:
        OpenNebula:
            dsmode: net
    dest: /etc/cloud/cloud.cfg.d/01_fedcloud.cfg

- name: enable service 
  service: 
    name: "{{ item }}"
    enabled: yes
  loop:
    - cloud-init-local
    - cloud-init
    - cloud-config
    - cloud-final
